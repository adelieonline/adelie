<h3>Order Summary</h3>
<label>
  Items (<%= @items %>): $<%= number_with_precision(@price, :precision => 2) %>
</label>
<br />
<label>
  Shipping/Handling: $0.00
</label>
<br />
<label>
  Tax (6.25%): $<%= number_with_precision(@tax, :precision => 2) %>
</label>
<br />
<label>
  Total Price: $<%= number_with_precision(@total, :precision => 2) %>
</label>
<h3>Items:</h3>
<% @cart_items.each do |cart_item| %>
  <label>
    <%= cart_item[:product].name %>
  </label>
  <br />
  <label>
      $<%= number_with_precision(cart_item[:product].price, :precision => 2) %>
  </label>
  <br />
  <label>
    Quantity: 
  </label>
  <label>
    <%= cart_item[:quantity]%>
  </label>
  <br />
<% end %>
<br />
<br />
<form action="/checkout/checkout" method="POST" id="payment-form">
<div id="shippingForm">
  <h5>Shipping Address</h5>
  <span class="error" id="errorShippingName">Please enter a name</span>
  <label>Full Name:</label>
  <input type="text" name="shipping_name" id="shipping_name" />
  <br />

  <span class="error" id="errorShippingAddress">Please enter an address</span>
  <label>Address Line 1:</label>
  <input type="text" name="shipping_address_one" id="shipping_address_one" />
  <br />

  <label>Address Line 2:</label>
  <input type="text" name="shipping_address_two" id="shipping_address_two" />
  <br />

  <span class="error" id="errorShippingCity">Please enter a city</span>
  <label>City:</label>
  <input type="text" name="shipping_city" id="shipping_city" />
  <br />

  <span class="error" id="errorShippingState">Please enter a state</span>
  <label>State:</label>
  <select name="shipping_state" id="shipping_state">
    <option value="AL">Alabama</option>
    <option value="AK">Alaska</option>
    <option value="AZ">Arizona</option>
    <option value="AR">Arkansas</option>
    <option value="CA">California</option>
    <option value="CO">Colorado</option>
    <option value="CT">Connecticut</option>
    <option value="DE">Delaware</option>
    <option value="FL">Florida</option>
    <option value="GA">Georgia</option>
    <option value="HI">Hawaii</option>
    <option value="ID">Idaho</option>
    <option value="IL">Illinois</option>
    <option value="IN">Indiana</option>
    <option value="IA">Iowa</option>
    <option value="KS">Kansas</option>
    <option value="KY">Kentucky</option>
    <option value="LA">Louisiana</option>
    <option value="ME">Maine</option>
    <option value="MD">Maryland</option>
    <option value="MA">Massachusetts</option>
    <option value="MI">Michigan</option>
    <option value="MN">Minnesota</option>
    <option value="MS">Mississippi</option>
    <option value="MO">Missouri</option>
    <option value="MT">Montana</option>
    <option value="NE">Nebraska</option>
    <option value="NV">Nevada</option>
    <option value="NH">New Hampshire</option>
    <option value="NJ">New Jersey</option>
    <option value="NM">New Mexico</option>
    <option value="NY">New York</option>
    <option value="NC">North Carolina</option>
    <option value="ND">North Dakota</option>
    <option value="OH">Ohio</option>
    <option value="OK">Oklahoma</option>
    <option value="OR">Oregon</option>
    <option value="PA">Pennsylvania</option>
    <option value="RI">Rhode Island</option>
    <option value="SC">South Carolina</option>
    <option value="SD">South Dakota</option>
    <option value="TN">Tennessee</option>
    <option value="TX">Texas</option>
    <option value="UT">Utah</option>
    <option value="VT">Vermont</option>
    <option value="VA">Virginia</option>
    <option value="WA">Washington</option>
    <option value="WV">West Virginia</option>
    <option value="WI">Wisconsin</option>
    <option value="WY">Wyoming</option>
  </select>
  <br />

  <span class="error" id="errorShippingZip">Please enter a zip code</span>
  <label>Zip Code:</label>
  <input type="text" name="shipping_zip" id="shipping_zip" />
</div>
<div id="paymentInfoDiv">
  <h5>Payment Information</h5>
  <span class="payment-errors"></span>
  <% if @error %>
    <span class="error">There was an unknown error with your card. Please try again</span>
  <% end %>

  <div class="form-row">
    <label>
      <span>Card Number</span>
      <input type="text" size="20" data-stripe="number"/>
    </label>
  </div>

  <div class="form-row">
    <label>
      <span>CVC</span>
      <input type="text" size="4" data-stripe="cvc"/>
    </label>
  </div>

  <div class="form-row">
    <label>
      <span>Expiration (MM/YYYY)</span>
      <input type="text" size="2" data-stripe="exp-month"/>
    </label>
    <span> / </span>
    <input type="text" size="4" data-stripe="exp-year"/>
  </div>
  <br />
</div>
<input id="place_order" class="btn btn-primary" type="submit" value="Place your order" />
</form>
<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
<script type="text/javascript">
  Stripe.setPublishableKey('pk_test_VDibhwkeKEdInW1tMaW5fseP');
</script>
<script type="text/javascript">
  jQuery(function($) {
    $('#payment-form').submit(function(event) {
      var $form = $(this);
      $form.find('button').prop('disabled', true);
      $(".error").hide();
      shipping_name = $("#shipping_name").val();
      shipping_address_one = $("#shipping_address_one").val();
      shipping_address_two = $("#shipping_address_two").val();
      shipping_city = $("#shipping_city").val();
      shipping_state = $("#shipping_state").val();
      shipping_zip = $("#shipping_zip").val();
      var place_order = true;
      var zip_pattern = new RegExp(/^\d{5}(-\d{4})?$/);
      if (shipping_name == "") {
        $("#errorShippingName").show();
        place_order = false;
      }
      if (shipping_address_one == "") {
        $("#errorShippingAddress").show();
        place_order = false;
      }
      if (shipping_city == "") {
        $("#errorShippingCity").show();
        place_order = false;
      }
      if (shipping_state == "") {
        $("#errorShippingState").show();
        place_order = false;
      }
      if (shipping_zip == "" || !zip_pattern.test(shipping_zip)) {
        $("#errorShippingZip").show();
        place_order = false;
      }
      if (place_order)
        Stripe.card.createToken($form, stripeResponseHandler);
      return false;
    });
  });
  function stripeResponseHandler(status, response) {
    if (response.error) {
        $(".payment-errors").text(response.error.message);
    } else {
        var form$ = $("#payment-form");
        // token contains id, last4, and card type
        var token = response['id'];
        var last4 = response['card']['last4'];
        var card_type = response['card']['type'];
        // insert the token into the form so it gets submitted to the server
        form$.append("<input type='hidden' name='stripe_token' value='" + token + "'/>");
        form$.append("<input type='hidden' name='stripe_last_four' value='" + last4 + "'/>");
        form$.append("<input type='hidden' name='stripe_card_type' value='" + card_type + "'/>");
        form$.get(0).submit();
    }
  }
</script>
